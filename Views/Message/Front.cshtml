@model List<myhw.Models.MessageDataModel>

@{
    ViewBag.Title = "Message Board";
}

<h2>Message Board</h2>

@using (Html.BeginForm("Front", "Message", FormMethod.Get))
{
    <p>
        姓名: @Html.TextBox("name")
        <input type="submit" value="搜尋" />
    </p>
}

@if (Model != null && Model.Any())
{
    <table class="table">
        <tr>
            <th>姓名(帳號)</th>
            <th>留言</th>
            <th>時間</th>
            <th>操作</th>
        </tr>
        @foreach (var message in Model)
        {
            <tr>
                <td>@message.Username</td>
                <td>
                    <span class="message-content" data-original="@message.Content">@message.Content</span>
                    <input type="text" class="edit-content" value="@message.Content" style="display: none;" />
                </td>
                <td id="computerTime">@message.Timestamp.ToString("yyyy-MM-dd HH:mm:ss")</td>
                <td>
                    <button class="edit-btn">編輯</button>
                    <button class="save-btn" style="display: none;">完成</button>
                    @Html.ActionLink("刪除", "Delete", new { id = message.UserId }, new { @class = "delete-btn", data_user_id = message.UserId })

                </td>
            </tr>
        }
    </table>
}
else
{
    <p>没有可用的消息。</p>
}

@Html.ActionLink("Create Message", "Create", new { @class = "btn btn-primary" })

@section scripts {
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script>
        $(document).ready(function () {
            // 獲取當前時間
            var currentTime = new Date();
            var formattedTime = currentTime.toLocaleString();

            $("#computerTime").text(formattedTime);
        });
    </script>
    <script>
        $(document).ready(function () {
            $(".edit-btn").click(function () {
                var row = $(this).closest("tr");
                row.find(".message-content").hide();
                row.find(".edit-content").show();
                row.find(".edit-btn").hide();
                row.find(".save-btn").show();
            });

            $(".save-btn").click(function () {
                var row = $(this).closest("tr");
                var userId = row.find(".delete-btn").data("user-id");  // 修正這裡的名稱
                var editedContent = row.find(".edit-content").val();

                // 使用 Ajax 將修改後的內容提交到後端進行保存
                $.ajax({
                    type: "POST",
                    url: "/Message/UpdateMessage",
                    data: { userId: userId, content: editedContent },
                    success: function () {
                        // 更新成功後的處理
                        row.find(".message-content").text(editedContent);
                        row.find(".message-content").show();
                        row.find(".edit-content").hide();
                        row.find(".edit-btn").show();
                        row.find(".save-btn").hide();
                    },
                    error: function () {
                        // 更新失敗後的處理
                        alert("編輯失敗");
                    }
                });
            });

            $(".delete-btn").click(function () {
                var row = $(this).closest("tr");
                var userId = $(this).data("user-id");  // 修正這裡的名稱

                // 使用 Ajax 將 userId 提交到後端進行刪除
                $.ajax({
                    type: "POST",
                    url: "/Message/DeleteMessage",
                    data: { userId: userId },
                    success: function () {
                        // 刪除成功後的處理
                        row.remove();
                    },
                    error: function () {
                        // 刪除失敗後的處理
                        alert("刪除失敗");
                    }
                });
            });
        });
    </script>
    <script>
        $(document).ready(function () {
            // Your existing JavaScript code

            // 新增留言按鈕的點擊事件
            $(".create-btn").click(function () {
                // 導向到 Create 頁面
                window.location.href = '@Url.Action("Create", "Message")';
            });
        });
    </script>
}
