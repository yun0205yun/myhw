@model IPagedList<myhw.Models.MessageDataModel>

@{
    ViewBag.Title = "Message Board";
}

<h2>Message Board</h2>
<div id="gridcontainer">
    @Html.Partial("_ProductGrid", Model)<!--有錯-->
</div>
<!-- Partial _ProductGrid.cshtml view -->
@using (Html.BeginForm("Front", "Message", FormMethod.Get))
{
    <p>
        姓名: @Html.TextBox("name")
        <input type="submit" value="搜尋" />
    </p>
}

@if (Session["Username"] != null)
{
    <p>歡迎, @Session["Username"]！</p>
    @Html.ActionLink("登出", "Logout", "Message", new { @class = "btn btn-primary" })
}
else
{
    @Html.ActionLink("Login", "Log", "Account")
}

@if (Model != null && Model.Any())
{
    <table class="table">
        <tr>
            <th>姓名(帳號)</th>
            <th>留言</th>
            <th>時間</th>
            <th>操作</th>
        </tr>
        @foreach (var message in Model)
        {
            <tr>
                <td>@message.Username</td>
                <td>
                    <span class="message-content" data-original="@message.Content">@message.Content</span>
                    <input type="text" class="edit-content" value="@message.Content" style="display: none;" />
                </td>
                <td id="computerTime">@message.Timestamp.ToString("yyyy-MM-dd HH:mm:ss")</td>
                <td>
                    @if (Session["Username"] != null && Session["Username"].ToString() == message.Username)
                    {
                        <button class="edit-btn" data-content-id="@message.UserId">編輯</button>
                        <button class="save-btn" style="display: none;">完成</button>
                        <button class="delete-btn" data-content-id="@message.ContentId">刪除</button>
                    }
                    else
                    {
                        <text>你沒有權限</text>
                    }
                </td>
            </tr>
        }
    </table>
    <div id="PagedListContainer">
        @if (ViewBag.name != null)
        {
            @Html.Pager(Model.PageSize, Model.PageIndex, Model.TotalItemCount, new AjaxOptions { UpdateTargetId = "gridcontainer" }).Options(O => O.AddRouteValue("name", ViewBag.name))
        }
        else
        {
            @Html.Pager(Model.PageSize, Model.PageIndex, Model.TotalItemCount, new AjaxOptions { UpdateTargetId = "gridcontainer" }).Options(o => o.Action("Front"))
        }
    </div>


}
else
{
    <p>没有可用的消息。</p>
}



<button class="create-btn btn btn-primary">Create Message</button>
<p>@Html.ActionLink("回到全部留言", "Front", new { @class = "btn btn-secondary" })</p>

@section scripts {
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-ajax-unobtrusive/3.2.6/jquery.unobtrusive-ajax.min.js"></script>
    <script>
        $(document).ready(function () {
            // 獲取當前時間
            var currentTime = new Date();
            var formattedTime = currentTime.toLocaleString();
            $("#computerTime").text(formattedTime);

            // 編輯按紐事件
            $(".edit-btn").click(function () {
                var row = $(this).closest("tr");
                row.find(".message-content").hide();
                row.find(".edit-content").val(row.find(".message-content").text());
                row.find(".edit-content").show();
                row.find(".edit-btn").hide();
                row.find(".save-btn").show();
            });

            $(".save-btn").click(function () {
                var row = $(this).closest("tr");
                var contentId = row.find(".edit-btn").data("content-id");
                var editedContent = row.find(".edit-content").val();

                $.ajax({
                    type: "POST",
                    url: "/Message/UpdateMessage",
                    data: { contentId: contentId, content: editedContent },
                    success: function (response) {
                        if (response.Success) {
                            alert("操作成功：" + response.Message);
                            row.find(".message-content").text(editedContent);
                            row.find(".message-content").show();
                            row.find(".edit-content").hide();
                            row.find(".edit-btn").show();
                            row.find(".save-btn").hide();
                        } else {
                            alert("操作失敗：" + response.Message);
                        }
                    },
                    error: function () {
                        alert("發生錯誤");
                    }
                });
            });

            $(".delete-btn").click(function () {
                var row = $(this).closest("tr");
                var contentId = $(this).data("content-id");

                $.ajax({
                    type: "POST",
                    url: "/Message/DeleteMessage",
                    data: { contentId: contentId },
                    success: function (response) {
                        if (response.Success) {
                            row.remove();
                            alert("刪除成功：" + response.Message);
                            location.reload(); // 重新加載當前頁面

                        } else {
                            alert("刪除失敗：" + response.Message);
                        }
                    },
                    error: function () {
                        alert("失敗");
                    }
                });
            });

            $(".create-btn").click(function () {
                window.location.href = '@Url.Action("Create", "Message")';
            });
        });
    </script>
}
