@using PagedList.Mvc
@model PagedList.IPagedList<myhw.Models.MessageDataModel>

@{
    ViewBag.Title = "Message Board";
}

<h2>Message Board</h2>

@using (Html.BeginForm("Front", "Message", FormMethod.Get))
{
    <p>
        姓名: @Html.TextBox("name")
        <input type="submit" value="搜尋" />
    </p>
}

@if (Session["Username"] != null)
{
    <p>歡迎, @Session["Username"]！</p>
    @Html.ActionLink("登出", "Logout", "Message", new { @class = "btn btn-primary" })
}
else
{
    @Html.ActionLink("Login", "Log", "Account")
}

@if (Model != null && Model.Any())
{
    <table class="table">
        <tr>
            <th>姓名(帳號)</th>
            <th>留言</th>
            <th>時間</th>
            <th>操作</th>
        </tr>
        @foreach (var message in Model)
        {
            <tr>
                <td>@message.Username</td>
                <td>
                    <span class="message-content" data-original="@message.Content">@message.Content</span>
                    <input type="text" class="edit-content" value="@message.Content" style="display: none;" />
                </td>
                <td id="computerTime">@message.Timestamp.ToString("yyyy-MM-dd HH:mm:ss")</td>
                <td>
                    @if (Session["Username"] != null && Session["Username"].ToString() == message.Username)
                    {
                        <button class="edit-btn" data-content-id="@message.UserId">編輯</button>
                        <button class="save-btn" style="display: none;">完成</button>
                        @Html.ActionLink("刪除", "Delete", new { id = message.ContentId}, new { @class = "delete-btn", data_content_id = message.ContentId})
                    }
                    else
                    {
                        <text>你沒有權限</text>
                    }
                </td>
            </tr>
        }
    </table>
    <div class="pagination-container">
        @Html.PagedListPager(Model, page => page == 1 ? Url.Action("Front", new { page }) : Url.Action("Front", new { page = page }))
    </div>
}
else
{
    <p>没有可用的消息。</p>
}

<button class="create-btn btn btn-primary">Create Message</button>

@section scripts {
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script>
        $(document).ready(function () {
            // 获取当前时间
            var currentTime = new Date();
            var formattedTime = currentTime.toLocaleString();
            $("#computerTime").text(formattedTime);

            // 编辑按钮点击事件
            $(".edit-btn").click(function () {
                var row = $(this).closest("tr");
                row.find(".message-content").hide();
                row.find(".edit-content").val(row.find(".message-content").text());
                row.find(".edit-content").show();
                row.find(".edit-btn").hide();
                row.find(".save-btn").show();
            });


            // 保存按钮点击事件
            $(".save-btn").click(function () {
                var row = $(this).closest("tr");
                var contentId = row.find(".edit-btn").data("content-id"); // 使用 data-content-id 属性获取 contentId
                var editedContent = row.find(".edit-content").val();

                // 使用 Ajax 将修改后的内容提交到后端进行保存
                $.ajax({
                    type: "POST",
                    url: "/Message/UpdateMessage",
                    data: { contentId: contentId, content: editedContent }, 
                    success: function (response) {
   
                        if (response.Success) {
                            // 成功的处理逻辑
                            alert("操作成功：" + response.Message);//這裡要注意大小寫的問題
                            // 切換回編輯狀態
                            row.find(".message-content").text(editedContent);
                            row.find(".message-content").show();
                            row.find(".edit-content").hide();
                            row.find(".edit-btn").show();
                            row.find(".save-btn").hide();
                        } else {
                            // 失败的处理逻辑
                            alert("操作失敗：" + response.Message);
                        }
                    },
                    error: function () {
                        // 异常处理逻辑
                        alert("發生錯誤");
                    }
                });
            });



            // 删除按钮点击事件
            $(".delete-btn").click(function () {
                var row = $(this).closest("tr");
                var contentId = $(this).data("content-id"); // 使用 data-content-id 属性获取 contentId

                // 使用 Ajax 将 contentId 提交到后端进行删除
                $.ajax({
                    type: "POST",
                    url: "/Message/DeleteMessage",
                    data: { contentId: contentId }, // 使用 contentId 作为参数
                    success: function (response) {

                        if (response.Success) {
                            // 刪除成功 
                            row.remove();
                            alert("刪除成功：" + response.Message);
                        } else {
                            // 刪除失敗
                            alert("刪除失敗：" + response.Message);
                        }
                    },
                    error: function () {
                        alert("失敗");
                    }
                });
            });

            // 创建留言按钮点击事件
            $(".create-btn").click(function () {
                // 导向到 Create 页面
                window.location.href = '@Url.Action("Create", "Message")';
            });
        });
    </script>
}
